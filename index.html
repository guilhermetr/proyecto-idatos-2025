<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tablero Integrado MGAP · Clima · Producción · Precios</title>
  <style>
    :root{
      --bg-app:#0f172a;--bg-surface:#1e2538;--bg-surface-alt:#2a344d;--border-color:rgba(255,255,255,.08);
      --text-primary:#f8fafc;--text-dim:#94a3b8;--accent:#38bdf8;--accent-bg:rgba(56,189,248,.12);
      --radius-lg:1rem;--radius-md:.5rem;--radius-sm:.25rem;
      --fs-300:.8rem;--fs-400:.9rem;--fs-500:1rem;--fs-600:1.125rem;--fs-700:1.25rem;--fs-800:1.5rem;--fs-900:2rem;
      --space-2xs:.25rem;--space-xs:.5rem;--space-sm:.75rem;--space-md:1rem;--space-lg:1.5rem;--space-xl:2rem;
      --card-bg-gradient:radial-gradient(circle at 20% 20%,rgba(56,189,248,.15) 0%,rgba(30,37,56,0) 70%);
      --focus-ring:0 0 0 2px rgba(56,189,248,.5)
    }

    *,*::before,*::after{box-sizing:border-box}
    body{
      background:var(--bg-app);
      color:var(--text-primary);
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Inter","Roboto","Segoe UI","Helvetica Neue",Arial,sans-serif;
      margin:0;
      line-height:1.4
    }

    .app-header{
      display:flex;
      flex-wrap:wrap;
      justify-content:space-between;
      align-items:flex-start;
      padding:var(--space-md) var(--space-lg);
      border-bottom:1px solid var(--border-color);
      background:rgba(15,23,42,.6);
      backdrop-filter:blur(8px);
      position:sticky;
      top:0;
      z-index:100
    }
    .app-header__titles h1{
      font-size:var(--fs-800);
      font-weight:600;
      margin:0
    }
    .subtitle{
      margin-top:var(--space-2xs);
      color:var(--text-dim);
      font-size:var(--fs-400)
    }
    .app-header__global-controls{
      display:flex;
      gap:var(--space-sm);
      flex-shrink:0;
      flex-wrap:wrap
    }

    .layout{
      display:grid;
      grid-template-columns:360px 1fr;
      gap:var(--space-lg);
      padding:var(--space-lg)
    }
    @media (min-width:1400px){
      .layout{grid-template-columns:420px 1fr}
    }
    @media (max-width:900px){
      .layout{grid-template-columns:1fr}
    }

    .sidebar{
      display:flex;
      flex-direction:column;
      gap:var(--space-lg);
      position:sticky;
      top:88px;
      align-self:start
    }
    .filter-block,.meta-block{
      background:var(--bg-surface);
      border:1px solid var(--border-color);
      border-radius:var(--radius-lg);
      padding:var(--space-md);
      box-shadow:0 16px 40px rgba(0,0,0,.6)
    }
    .filter-block__title{
      font-size:var(--fs-600);
      font-weight:500;
      margin:0 0 var(--space-md)
    }

    .form-field{
      display:flex;
      flex-direction:column;
      margin-bottom:var(--space-md);
      font-size:var(--fs-400)
    }
    .form-field--row{
      display:flex;
      flex-direction:row;
      justify-content:space-between;
      gap:var(--space-sm)
    }
    .form-field--row > div{
      flex:1 1 0;
      min-width:0;
    }

    .form-label{
      color:var(--text-dim);
      font-size:var(--fs-300);
      margin-bottom:var(--space-2xs)
    }
    .form-input{
      background:var(--bg-surface-alt);
      border:1px solid var(--border-color);
      border-radius:var(--radius-md);
      padding:var(--space-sm) var(--space-md);
      color:var(--text-primary);
      font-size:var(--fs-500);
      width:100%;
      min-height:2.5rem
    }
    .form-input:focus{
      outline:0;
      box-shadow:var(--focus-ring);
      border-color:var(--accent)
    }

    .btn{
      font-size:var(--fs-400);
      border-radius:var(--radius-md);
      padding:var(--space-sm) var(--space-md);
      border:1px solid transparent;
      cursor:pointer;
      line-height:1.2;
      font-weight:500;
      min-height:2.5rem;
      background:none;
      color:var(--text-primary)
    }
    .btn-primary{
      background:var(--accent);
      color:#0f172a;
      border-color:var(--accent)
    }
    .btn-outline{
      background:transparent;
      border-color:var(--border-color)
    }
    .btn-ghost{
      background:transparent;
      border-color:transparent;
      color:var(--text-dim)
    }
    .btn-block{width:100%}
    .btn:focus{
      outline:0;
      box-shadow:var(--focus-ring)
    }

    .meta-list{
      color:var(--text-dim);
      font-size:var(--fs-400);
      padding-left:1rem;
      margin:0
    }
    .meta-list li{margin-bottom:var(--space-sm)}

    .main{
      display:flex;
      flex-direction:column;
      gap:var(--space-lg)
    }

    .cards-row{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(min(220px,100%),1fr));
      gap:var(--space-md)
    }
    .card{
      background:var(--bg-surface);
      border:1px solid var(--border-color);
      border-radius:var(--radius-lg);
      padding:var(--space-md);
      box-shadow:0 24px 64px rgba(0,0,0,.7);
      position:relative;
      overflow:hidden
    }
    .card::after{
      content:"";
      position:absolute;
      inset:0;
      background-image:var(--card-bg-gradient);
      mix-blend-mode:screen;
      opacity:.6;
      pointer-events:none
    }
    .card__header{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      font-size:var(--fs-400);
      color:var(--text-dim)
    }
    .card__unit{
      background:var(--accent-bg);
      color:var(--accent);
      border-radius:var(--radius-sm);
      padding:0 var(--space-xs);
      font-size:var(--fs-300);
      line-height:1.4;
      border:1px solid rgba(56,189,248,.4)
    }
    .card__value{
      margin-top:var(--space-xs);
      font-size:var(--fs-900);
      font-weight:600
    }
    .card__footer{
      margin-top:var(--space-xs);
      font-size:var(--fs-300);
      color:var(--text-dim)
    }

    .table-section{
      background:var(--bg-surface);
      border:1px solid var(--border-color);
      border-radius:var(--radius-lg);
      padding:var(--space-md) var(--space-md) var(--space-lg);
      box-shadow:0 24px 64px rgba(0,0,0,.7)
    }
    .table-header h3{
      font-size:var(--fs-600);
      font-weight:500;
      margin:0 0 var(--space-2xs)
    }
    .table-header p{
      color:var(--text-dim);
      font-size:var(--fs-300);
      margin:0 0 var(--space-md)
    }
    .table-wrapper{
      max-height:300px;
      overflow:auto;
      border-radius:var(--radius-md);
      border:1px solid var(--border-color)
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:var(--fs-400);
      min-width:700px
    }
    thead{
      background:var(--bg-surface-alt);
      position:sticky;
      top:0;
      z-index:2
    }
    th{
      text-align:left;
      font-weight:500;
      color:var(--text-primary);
      padding:var(--space-sm) var(--space-md);
      border-bottom:1px solid var(--border-color);
      white-space:nowrap;
      font-size:var(--fs-300)
    }
    tbody tr:nth-child(even){background:rgba(255,255,255,.02)}
    td{
      padding:var(--space-sm) var(--space-md);
      color:var(--text-dim);
      border-bottom:1px solid var(--border-color);
      vertical-align:top;
      font-size:var(--fs-400)
    }

    .app-footer{
      border-top:1px solid var(--border-color);
      background:rgba(15,23,42,.4);
      padding:var(--space-lg);
      font-size:var(--fs-300);
      color:var(--text-dim);
      line-height:1.5;
      margin-top:var(--space-xl);
      text-align:center
    }

    .loading-overlay{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.92);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:0.75rem;
      color:var(--text-dim);
      font-size:var(--fs-500);
      z-index:9999;
      backdrop-filter:blur(6px);
    }
    .loading-spinner{
      width:32px;
      height:32px;
      border-radius:999px;
      border:3px solid rgba(148,163,253,.25);
      border-top-color:var(--accent);
      animation:spin .8s linear infinite;
    }
    @keyframes spin{
      to{transform:rotate(360deg)}
    }
    .hidden{display:none}
  </style>
</head>
<body>
  <div id="loadingOverlay" class="loading-overlay hidden">
    <div class="loading-spinner"></div>
    <div id="loadingText">Cargando datos integrados desde las fuentes...</div>
  </div>

  <header class="app-header">
    <div class="app-header__titles">
      <h1>Integración de datos frutícolas</h1>
      <p class="subtitle">Clima (INUMET), Producción (UAM), Precios (MEF) · Manzana</p>
    </div>
    <div class="app-header__global-controls">
      <button id="exportCsvBtn" class="btn btn-outline">Descargar CSV</button>
    </div>
  </header>

  <div class="layout">
    <aside class="sidebar">
  <section class="filter-block">
    <h2 class="filter-block__title">Filtros</h2>

    <label class="form-field">
      <span class="form-label">Región / zona</span>
      <select id="regionSelect" class="form-input"></select>
    </label>

    <div class="form-field form-field--row">
      <div>
        <span class="form-label">Desde</span>
        <input type="date" id="startDate" class="form-input" />
      </div>
      <div>
        <span class="form-label">Hasta</span>
        <input type="date" id="endDate" class="form-input" />
      </div>
    </div>

    <label class="form-field">
      <span class="form-label">Agregación temporal</span>
      <select id="aggSelect" class="form-input">
        <option value="month" selected>Mes</option>
        <option value="year">Año</option>
      </select>
    </label>

    <button id="applyFiltersBtn" class="btn btn-primary btn-block">Aplicar filtros</button>
    <button id="toggleCompleteBtn" class="btn btn-ghost btn-block" style="margin-top:0.5rem;">
      Solo filas completas
    </button>
  </section>

  <section class="meta-block">
    <h2 class="filter-block__title">Notas metodológicas</h2>
    <ul class="meta-list">
      <li>La función serverless integra clima, producción y precios en tiempo de consulta.</li>
      <li>La vista está agregada por Mes/Año y Departamento. Fruta fija: Manzana.</li>
    </ul>
  </section>
</aside>


    <main class="main">
      <section class="cards-row" aria-label="Indicadores resumidos">
        <article class="card">
          <header class="card__header">
            <span class="card__title">Temp. promedio</span>
            <span class="card__unit">°C</span>
          </header>
          <div class="card__value" id="kpiTemp">--</div>
          <footer class="card__footer" id="kpiTempMeta">Promedio</footer>
        </article>

        <article class="card">
          <header class="card__header">
            <span class="card__title">Producción total</span>
            <span class="card__unit">toneladas</span>
          </header>
          <div class="card__value" id="kpiProduction">--</div>
          <footer class="card__footer" id="kpiProdMeta">Suma</footer>
        </article>

        <article class="card">
          <header class="card__header">
            <span class="card__title">Precio promedio</span>
            <span class="card__unit">$ / kg</span>
          </header>
          <div class="card__value" id="kpiPrice">--</div>
          <footer class="card__footer" id="kpiPriceMeta">Promedio</footer>
        </article>
      </section>

      <section class="table-section">
        <div class="table-header">
          <h3>Observaciones integradas</h3>
          <p>Cada fila resume clima, producción y precio de manzana para una zona y período.</p>
        </div>
        <div class="table-wrapper">
          <table class="data-table" id="dataTable">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Zona</th>
                <th>Lluvia (mm)</th>
                <th>T. prom (°C)</th>
                <th>Humedad (%)</th>
                <th>Producción (t)</th>
                <th>Precio ($/kg)</th>
                <th>Fuente</th>
              </tr>
            </thead>
            <tbody id="dataTableBody"></tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <footer class="app-footer">
    <p>Este tablero cruza clima, producción y precios de manzana por período y departamento a partir de fuentes públicas.</p>
    <p>Ministerio de Ganadería, Agricultura y Pesca · Integración de vistas virtuales</p>
  </footer>

<script>
    const API_URL = "/api/main";

    // ================= Helpers =================

    function numOrNull(v){
      if(v === undefined || v === null || v === "") return null;
      const n = Number(String(v).replace(",", "."));
      return Number.isNaN(n) ? null : n;
    }

    function toIsoDate(raw){
      if(!raw) return null;
      let s = String(raw).trim();

      if (/^\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}/.test(s)) {
        s = s.split(" ")[0];
      }

      let m = s.match(/^(\d{4})[-/](\d{2})[-/](\d{2})$/);
      if (m) return `${m[1]}-${m[2]}-${m[3]}`;

      m = s.match(/^(\d{2})[-/](\d{2})[-/](\d{4})$/);
      if (m) return `${m[3]}-${m[2]}-${m[1]}`;

      m = s.match(/^(\d{4})-(\d{2})$/);
      if (m) return `${m[1]}-${m[2]}`;

      const d = new Date(s);
      if (!Number.isNaN(d.getTime())){
        const yyyy = String(d.getFullYear()).padStart(4,"0");
        const mm   = String(d.getMonth()+1).padStart(2,"0");
        const dd   = String(d.getDate()).padStart(2,"0");
        return `${yyyy}-${mm}-${dd}`;
      }
      return null;
    }

    function formatDateEs(s){
      let m = s.match(/^(\d{4})-(\d{2})-Q(\d)$/);
      if (m) return `Q${m[3]} ${m[2]}/${m[1]}`;

      m = s.match(/^(\d{4})-(\d{2})$/);
      if (m) return `${m[2]}/${m[1]}`;

      m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if (m) return `${m[3]}/${m[2]}/${m[1]}`;

      m = s.match(/^(\d{4})$/);
      if (m) return m[1];

      return s;
    }

    function fmt1(n){
      return (n==null||Number.isNaN(n)) ? "--" : Number(n).toFixed(1);
    }
    function avg(arr){
      if(!arr.length) return null;
      return arr.reduce((a,b)=>a+b,0)/arr.length;
    }
    function sum(arr){
      if(!arr.length) return null;
      return arr.reduce((a,b)=>a+b,0);
    }

    // ================= Aggregation helpers =================

    function ymdParts(fechaStr) {
      const parts = String(fechaStr).split("-");
      const yy = parseInt(parts[0], 10);
      const mm = parseInt(parts[1] ?? "1", 10);
      const dd = parseInt(parts[2] ?? "1", 10);
      return {yy, mm, dd};
    }

    function aggReducerInit() {
      return {
        count: 0,
        lluvia_mm_sum: 0,
        temp_list: [],
        hum_list: [],
        prod_sum_tn: 0,
        price_list: [],
        origenes: new Set(),
        sampleFecha: null,
        sampleRegion: null,
        sampleFruta: null
      };
    }

    function aggReducerAcc(acc, row){
      acc.count += 1;

      if (row.lluvia_mm != null && !Number.isNaN(row.lluvia_mm)) {
        acc.lluvia_mm_sum += Number(row.lluvia_mm);
      }
      if (row.temp_c != null && !Number.isNaN(row.temp_c)) {
        acc.temp_list.push(Number(row.temp_c));
      }
      if (row.hum_pje != null && !Number.isNaN(row.hum_pje)) {
        acc.hum_list.push(Number(row.hum_pje));
      }
      if (row.produccion_tn != null && !Number.isNaN(row.produccion_tn)) {
        acc.prod_sum_tn += Number(row.produccion_tn);
      }
      if (row.precio_kg != null && !Number.isNaN(row.precio_kg)) {
        acc.price_list.push(Number(row.precio_kg));
      }
      if (row.origen_fuente) {
        acc.origenes.add(row.origen_fuente);
      }

      if (!acc.sampleFecha)  acc.sampleFecha  = row.fecha;
      if (!acc.sampleRegion) acc.sampleRegion = row.region ?? null;
      if (!acc.sampleFruta)  acc.sampleFruta  = row.fruta ?? null;

      return acc;
    }

    function finalizeAggRecord(acc, meta){
      const lluvia_mm = acc.lluvia_mm_sum || null;
      const temp_c    = acc.temp_list.length ? avg(acc.temp_list) : null;
      const hum_pje   = acc.hum_list.length ? avg(acc.hum_list) : null;
      const produccion_tn = acc.prod_sum_tn || null;
      const precio_kg = acc.price_list.length ? avg(acc.price_list) : null;

      const origen_fuente = Array.from(acc.origenes).join(" + ") || null;

      let fechaOut = acc.sampleFecha;
      if (meta.type === "month") {
        const {yy,mm} = meta;
        fechaOut = `${yy}-${String(mm).padStart(2,"0")}`;
      } else if (meta.type === "year") {
        const {yy} = meta;
        fechaOut = `${yy}`;
      }

      return {
        fecha: fechaOut,
        region: acc.sampleRegion,
        fruta: acc.sampleFruta,
        lluvia_mm,
        temp_c,
        hum_pje,
        produccion_tn,
        precio_kg,
        origen_fuente
      };
    }

    function aggregateData(data){
      const mode = state.agg; // "month" | "year"
      if (!data.length) return [];

      const buckets = new Map();

      for (const row of data){
        if (!row.fecha) continue;
        const {yy,mm} = ymdParts(row.fecha);
        const regionKey = row.region ?? "";

        let key, meta;
        if (mode === "year"){
          key  = ["year", yy, regionKey].join("|");
          meta = {type:"year", yy};
        } else { // month
          key  = ["month", yy, mm, regionKey].join("|");
          meta = {type:"month", yy, mm};
        }

        if (!buckets.has(key)){
          buckets.set(key, { acc: aggReducerInit(), meta });
        }
        const bucket = buckets.get(key);
        aggReducerAcc(bucket.acc, row);
      }

      const out = [];
      for (const {acc, meta} of buckets.values()){
        out.push(finalizeAggRecord(acc, meta));
      }

      out.sort((a,b)=>{
        const pa = String(a.fecha);
        const pb = String(b.fecha);
        if (pa < pb) return -1;
        if (pa > pb) return 1;
        if ((a.region||"") < (b.region||"")) return -1;
        if ((a.region||"") > (b.region||"")) return 1;
        return 0;
      });

      return out;
    }

    // ================= State & DOM =================

    let combinedRows = [];

    const state = {
      region: null,
      startDate: null,
      endDate: null,
      agg: "month",
      onlyComplete: false,
      filteredData: []
    };

    const regionSelect        = document.getElementById("regionSelect");
    const startDateInput      = document.getElementById("startDate");
    const endDateInput        = document.getElementById("endDate");
    const aggSelect           = document.getElementById("aggSelect");
    const applyFiltersBtn     = document.getElementById("applyFiltersBtn");
    const toggleCompleteBtn   = document.getElementById("toggleCompleteBtn");
    const exportCsvBtn        = document.getElementById("exportCsvBtn");

    const kpiTemp             = document.getElementById("kpiTemp");
    const kpiTempMeta         = document.getElementById("kpiTempMeta");
    const kpiProduction       = document.getElementById("kpiProduction");
    const kpiProdMeta         = document.getElementById("kpiProdMeta");
    const kpiPrice            = document.getElementById("kpiPrice");
    const kpiPriceMeta        = document.getElementById("kpiPriceMeta");

    const dataTableBody       = document.getElementById("dataTableBody");

    const loadingOverlay      = document.getElementById("loadingOverlay");
    const loadingTextEl       = document.getElementById("loadingText");

    // ================= Loading UI =================

    function setLoading(isLoading, message){
      if (message) loadingTextEl.textContent = message;
      if (isLoading){
        loadingOverlay.classList.remove("hidden");
      } else {
        loadingOverlay.classList.add("hidden");
      }
      [applyFiltersBtn, toggleCompleteBtn, exportCsvBtn].forEach(btn=>{
        if(!btn) return;
        btn.disabled = !!isLoading;
      });
    }

    // ================= Backend integration =================

    async function fetchBackendTable(){
      console.log("[frontend] Llamando API:", API_URL);
      const resp = await fetch(API_URL, { cache: "no-store" });
      console.log("[frontend] Status:", resp.status);

      if(!resp.ok){
        throw new Error("Error al llamar al backend: " + resp.status);
      }
      const json = await resp.json();
      console.log("[frontend] JSON crudo:", json);

      const rows = Array.isArray(json.data)
        ? json.data
        : Array.isArray(json)
          ? json
          : [];

      console.log("[frontend] Filas recibidas:", rows.length);
      console.log(rows[0]);

      if (!rows.length){
        return [];
      }

      const mapped = rows
        .map(r => {
          const mesAnio =
            r["Mes_año"] ?? r.Mes_año ?? r.mes_año ?? r.mes_ano ?? null;
          const fecha = mesAnio ? String(mesAnio) : toIsoDate(r.fecha ?? r.date);

          const region = r.Departamento ?? r.departamento ?? r.region ?? null;

          const lluvia_mm = numOrNull(r.Precip_Total_mm ?? r.precip_total_mm);
          const temp_c    = numOrNull(r.Temp_Media_C ?? r.temp_media_c);
          const hum_pje   = numOrNull(r.Hum_Media_Pje ?? r.hum_media_pje);

          const prodKg    = numOrNull(r.Produccion_kg ?? r.produccion_kg);
          const produccion_tn = prodKg != null ? prodKg / 1000 : null;

          const precio_kg = numOrNull(r.Precio_kg ?? r.precio_kg);

          return {
            fecha,
            region,
            fruta: "Manzana",
            lluvia_mm,
            temp_c,
            hum_pje,
            produccion_tn,
            precio_kg,
            origen_fuente: r.origen_fuente || "INUMET_temperatura, INUMET_humedad, INUMET_precipitaciones, UAM_produccion, MEF_precios"
          };
        })
        .filter(r => r.fecha && r.region);

      console.log("[frontend] Mapeadas:", mapped.length, "ejemplo:", mapped[0]);
      return mapped;
    }

    async function loadData(){
      try{
        setLoading(true, "Cargando datos integrados desde el mediador...");
        combinedRows = await fetchBackendTable();
        window._debugRows = combinedRows;
        initFilterControlsFromData();
        renderAll();
      }catch(e){
        console.error(e);
        dataTableBody.innerHTML = "";
        const tr=document.createElement("tr");
        const td=document.createElement("td");
        td.colSpan=8;
        td.textContent="Error al cargar datos desde el backend.";
        tr.appendChild(td);
        dataTableBody.appendChild(tr);
      }finally{
        setLoading(false);
      }
    }

    // ================= Rendering =================

    function toDateStrict(s){
      if (!s) return new Date(NaN);
      const parts = s.split("-").map(Number);
      if (parts.length === 3){
        return new Date(parts[0], parts[1]-1, parts[2]);
      }
      if (parts.length === 2){
        return new Date(parts[0], parts[1]-1, 1);
      }
      if (parts.length === 1){
        return new Date(parts[0], 0, 1);
      }
      return new Date(NaN);
    }

    function applyFilters(){
      const fRegion = state.region;
      const fStart = state.startDate ? toDateStrict(state.startDate) : null;
      const fEnd   = state.endDate ? toDateStrict(state.endDate)   : null;

      let out = combinedRows.filter(r=>{
        if (fRegion && r.region !== fRegion) return false;
        const d = toDateStrict(r.fecha);
        if (fStart && d < fStart) return false;
        if (fEnd && d > fEnd) return false;
        return true;
      });

      let aggregated = aggregateData(out);

      if (state.onlyComplete){
        aggregated = aggregated.filter(row =>
          row.lluvia_mm != null && !Number.isNaN(row.lluvia_mm) &&
          row.temp_c != null && !Number.isNaN(row.temp_c) &&
          row.hum_pje != null && !Number.isNaN(row.hum_pje) &&
          row.produccion_tn != null && !Number.isNaN(row.produccion_tn) &&
          row.precio_kg != null && !Number.isNaN(row.precio_kg)
        );
      }

      state.filteredData = aggregated;
    }

    const aggLabelEs = { month:"Mes", year:"Año" };

    function renderKPIs(){
      const d = state.filteredData;
      if (!d.length){
        kpiTemp.textContent = "--"; kpiTempMeta.textContent = "Sin datos en rango";
        kpiProduction.textContent = "--"; kpiProdMeta.textContent = "Sin datos en rango";
        kpiPrice.textContent = "--"; kpiPriceMeta.textContent = "Sin datos en rango";
        return;
      }

      const avgTemp   = avg(d.filter(r=>r.temp_c!=null).map(r=>r.temp_c));
      const totalProd = sum(d.filter(r=>r.produccion_tn!=null).map(r=>r.produccion_tn));
      const avgPrice  = avg(d.filter(r=>r.precio_kg!=null).map(r=>r.precio_kg));
      const aggTxt = aggLabelEs[state.agg] || "";

      kpiTemp.textContent      = fmt1(avgTemp);
      kpiTempMeta.textContent  = `Promedio por ${aggTxt.toLowerCase()}`;

      kpiProduction.textContent = totalProd != null ? fmt1(totalProd) : "--";
      kpiProdMeta.textContent   = `Suma por ${aggTxt.toLowerCase()}`;

      kpiPrice.textContent     = fmt1(avgPrice);
      kpiPriceMeta.textContent = `Promedio por ${aggTxt.toLowerCase()}`;
    }

    function renderTable(){
      dataTableBody.innerHTML = "";

      if (!state.filteredData.length){
        const tr=document.createElement("tr");
        const td=document.createElement("td");
        td.colSpan=8;
        td.textContent="Sin datos para los filtros seleccionados.";
        tr.appendChild(td);
        dataTableBody.appendChild(tr);
        return;
      }

      state.filteredData.forEach(row=>{
        const tr=document.createElement("tr");
        const cells=[
          formatDateEs(row.fecha),
          row.region ?? "",
          row.lluvia_mm != null    ? fmt1(row.lluvia_mm)      : "",
          row.temp_c != null       ? fmt1(row.temp_c)         : "",
          row.hum_pje != null      ? fmt1(row.hum_pje)        : "",
          row.produccion_tn != null? fmt1(row.produccion_tn)  : "",
          row.precio_kg != null    ? fmt1(row.precio_kg)      : "",
          getFuenteLabel(row)      // nuevo cálculo dinámico
        ];
        cells.forEach(v=>{
          const td=document.createElement("td");
          td.textContent=v;
          tr.appendChild(td);
        });
        dataTableBody.appendChild(tr);
      });
    }


    function updateCompleteButton(){
      if (!toggleCompleteBtn) return;
      if (state.onlyComplete){
        toggleCompleteBtn.classList.add("btn-primary");
        toggleCompleteBtn.classList.remove("btn-ghost");
        toggleCompleteBtn.textContent = "Ver todas las filas";
      } else {
        toggleCompleteBtn.classList.remove("btn-primary");
        toggleCompleteBtn.classList.add("btn-ghost");
        toggleCompleteBtn.textContent = "Solo filas completas";
      }
    }

    function renderAll(){
      applyFilters();
      renderKPIs();
      renderTable();
    }

    function initFilterControlsFromData(){
      const regions=[...new Set(combinedRows.map(r=>r.region).filter(Boolean))].sort();
      regionSelect.innerHTML =
        '<option value="">(todas)</option>' +
        regions.map(z=>`<option value="${z}">${z}</option>`).join("");

      const dates = combinedRows.map(r=>r.fecha).sort();
      const minDate = dates[0];
      const maxDate = dates[dates.length-1];

      startDateInput.value = minDate && minDate.length===7 ? `${minDate}-01` : (minDate || "");
      endDateInput.value   = maxDate && maxDate.length===7 ? `${maxDate}-01` : (maxDate || "");

      state.region        = "";
      state.startDate     = minDate || "";
      state.endDate       = maxDate || "";
      state.agg           = aggSelect.value;
      state.onlyComplete  = false;
      updateCompleteButton();
    }

    function getFuenteLabel(row){
      const sources = [];
      // INUMET: si hay al menos un dato climático
      if (
        (row.lluvia_mm != null && !Number.isNaN(row.lluvia_mm)) ||
        (row.temp_c    != null && !Number.isNaN(row.temp_c))    ||
        (row.hum_pje   != null && !Number.isNaN(row.hum_pje))
      ){
        sources.push("INUMET");
      }
      // UAM: si hay producción
      if (row.produccion_tn != null && !Number.isNaN(row.produccion_tn)){
        sources.push("UAM");
      }
      // MEF: si hay precio
      if (row.precio_kg != null && !Number.isNaN(row.precio_kg)){
        sources.push("MEF");
      }
      return sources.join(" · ");
    }

    // ================= Events =================

    applyFiltersBtn.addEventListener("click", ()=>{
      state.region    = regionSelect.value;
      state.startDate = startDateInput.value || state.startDate;
      state.endDate   = endDateInput.value   || state.endDate;
      state.agg       = aggSelect.value;
      renderAll();
    });

    toggleCompleteBtn.addEventListener("click", ()=>{
      state.onlyComplete = !state.onlyComplete;
      updateCompleteButton();
      renderAll();
    });

    exportCsvBtn.addEventListener("click", ()=>{
      if(!state.filteredData.length){
        alert("No hay datos para exportar.");
        return;
      }
      const headers=[
        "fecha","region",
        "lluvia_mm","temp_c","hum_pje",
        "produccion_tn","precio_kg",
        "fuente"
      ];
      const csv=[
        headers.join(","),
        ...state.filteredData.map(r=>{
          const fuente = getFuenteLabel(r);
          return [
            r.fecha ?? "",
            r.region ?? "",
            r.lluvia_mm ?? "",
            r.temp_c ?? "",
            r.hum_pje ?? "",
            r.produccion_tn ?? "",
            r.precio_kg ?? "",
            fuente
          ].join(",");
        })
      ].join("\n");

      const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"});
      const url=URL.createObjectURL(blob);
      const a=document.createElement("a");
      a.href=url;
      a.download="export_mgap.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    // ================= Boot =================

    (async function boot(){
      await loadData();
    })();
</script>

</body>
</html>
